---
title: "NF-kB sites"
author: "Панюшев Николай"
date: '29 марта 2017 г '
output: html_document
---

## Цель и задачи этого маленького проектика

Я решил подобрать праймеры для контроля чипсековской библиотеки для секвенирования, чтобы контролировать обогащение. Если эксперимент прошел успешно, то в IP сигнал должен быть гораздо сильнее, чем в IP c неспецифическими IgG. 

Chip-seq мы будем проводить на H1299, а на них экспериментов не делалось, к сожалению.

Поэтому я решил взять клеточные линии: A549, SGBS, IMR90, HeLa, HUVEC, MCF7 и отобрать из них самые мощные пики. Итак, посмотрим, что из этого вышло.



```{r libraries import, echo=F, warning=FALSE, message=FALSE}
library(ggplot2)
library(corrplot)
library(tidyr)
#library(stargazer, quietly = TRUE)
```

## Импорт данных

Сделаем функцию, которая будет нам данные считывать и сразу фильтровать

Добавить сюда штуку, которая будет levels от хромосом переименовывать и в правильном порядке расставлять

```{r import&filtering function}
read.narrowpeak <- function(filename, filtering=TRUE){
  raw_peaks <-  read.table(filename, header = F, sep = "\t")
  names(raw_peaks) <- c("Chromosome", "Start", "Stop", "Peak_name",
                        "display_int", "dot",
                        "fold_change", "p-value", "q-value",
                        "summit_position_from_start")
  
  if (filtering == TRUE){
    #Выбросим неинформативные колонки
    raw_peaks$dot = raw_peaks$display_int <- NULL
    #удаляем хромосомы, которые странно называются
    raw_peaks <- raw_peaks[grep(pattern = "chr\\w\\d?", raw_peaks$Chromosome), ]
    #Митохондриалку тоже выбросим, там не должно быть ТФ
    raw_peaks <- raw_peaks[!raw_peaks$Chromosome == "chrM",]
    #Переставим имена хромосом в нормальном порядке
    raw_peaks$Chromosome <- factor(raw_peaks$Chromosome, 
                                   levels =c("chr1","chr2","chr3","chr4","chr5",
                                    "chr6","chr7","chr8","chr9","chr10",
                                    "chr11", "chr12", "chr13", "chr14", "chr15",
                                    "chr16", "chr17", "chr18", "chr19", "chr20",
                                    "chr21", "chr22", "chrX", "chrY"))
    droplevels(raw_peaks)
    }
  return(raw_peaks)
}
```

Теперь считаем файлы с пиками с помощью этой чудодейственной функции

```{r file read, warning=FALSE}

A549_peaks <- read.narrowpeak("MACS2_p65_peaks/A549_TNF_vs_bg_peaks.narrowPeak")
HeLa_peaks <- read.narrowpeak("MACS2_p65_peaks/HELA_TNFvsDMSO_peaks.narrowPeak")
HUVEC_peaks <- read.narrowpeak("MACS2_p65_peaks/HUVEC_TNFvsASIS_peaks.narrowPeak")
IMR90_peaks <- read.narrowpeak("MACS2_p65_peaks/IMR90_TNFvsASIS_peaks.narrowPeak")
MCF7_peaks <- read.narrowpeak("MACS2_p65_peaks/MCF7_TNFvsVeh_peaks.narrowPeak")
SGBS_peaks <- read.narrowpeak("MACS2_p65_peaks/SGBS_TNFvsVeh_peaks.narrowPeak")
```

Итак, количество пиков по линиям

* A549 - `r nrow(A549_peaks)` 
* HeLa - `r nrow(HeLa_peaks)` - очень мало! 
* HUVEC - `r nrow(HUVEC_peaks)` 
* IMR90 - `r nrow(IMR90_peaks)` 
* MCF7 - `r nrow(MCF7_peaks)` - очень мало! 
* SGBS - `r nrow(SGBS_peaks)` 

Скорее всего, либо ошибка при пик-коллинге, или не прошла активация TNF. 
На вопрос, где ошибка, нам помогут ответить модельки, которые нам выдавал MACS2.

Картинка показывает насколько пики на + и - цепи смещены относительно друг друга. Если все сработало верно, то должно быть хорошее бимодальное распределение. Величина сдвига должна быть близка к размеру нуклеосомы. 

Клеточная линия  | Величина сдвига | Распределение ридов
------------- | ------------- | -------------
A549  | 261 п.н. | `r knitr::include_graphics("Peak_pics/A549_TNF_vs_bg_model-0.png", dpi = 200)`  
HUVEC | 115 п.н. | `r knitr::include_graphics("Peak_pics/HUVEC_TNFvsASIS_model-0.png", dpi = 200)`
IMR90 | 141 п.н. | `r knitr::include_graphics("Peak_pics/IMR90_TNFvsASIS_model-0.png", dpi = 200)`  
SGBS | 161 п.н.|  `r knitr::include_graphics("Peak_pics/SGBS_TNFvsVeh_model-0.png", dpi = 200)`  
HeLa | 34, 96, 500 п.н. |`r knitr::include_graphics("Peak_pics/HELA_TNFvsDMSO_model-0.png", dpi = 200)`  
MCF7 | 148 п.н. | `r knitr::include_graphics("Peak_pics/MCF7_TNFvsVeh_model-0.png", dpi = 200)`  

Итак, видим, что в HeLa какие-то проблемы с секвенированием произошли, и/или с экспериментом, поэтому от их использования придется отказаться.  
MCF7 - выглядит лучше, чем HeLa, но с ними тоже не все хорошо, откажемся от них  
A549 - Вызывает опасения, не очень красивое распределение и великоват сдвиг, но мы все равно попробуем с ними поработать.

Cложим все пики вместе, чтобы не возиться с 4мя датасетами, а сразу их объединить.

```{r merge peaks}
A549_peaks$Cell_line <- "A549"
HUVEC_peaks$Cell_line <- "HUVEC"
IMR90_peaks$Cell_line <- "IMR90"
SGBS_peaks$Cell_line <- "SGBS"
all_peaks <- rbind.data.frame(A549_peaks, HUVEC_peaks, IMR90_peaks, SGBS_peaks)
```

Теперь проанализируем fold_change, он должен давать нормальное распределение, что было бы вполне логично, и оно должно быть примерно одинаковым в разных линиях

```{r fold_change analysis, echo=FALSE}
ggplot(all_peaks, aes(fold_change, ..count.., fill = Chromosome))+
  geom_density(aes(fill=Chromosome), alpha = 0.5) +
  labs(title = "Fold change peak distribution",
       x = "Fold change",
       y = "Peak number")+
  theme_bw()+
  facet_wrap(~ Cell_line)
```

Прикольно, что у SGBS пиков аж в 3 раза больше, надо это взять на заметку!
Интересно, почему? 
Видимо, дело либо в клетках, либо сделано слишком много ридов  
Посмотрим на цифры:

```{r, echo=F}
attach(all_peaks)
chrom_peaks <- aggregate(all_peaks$Peak_name, by=list(Chromosome, Cell_line), FUN=length)
detach(all_peaks)
names(chrom_peaks) <- c("Chromosome", "Cell_line", "Peak_number")

chroms <- data.frame(chrom_peaks[chrom_peaks$Cell_line == "A549", c(1,3)])
names(chroms) <- c("Chromosome", "A549")
chroms$HUVEC <- chrom_peaks[chrom_peaks$Cell_line == "HUVEC", 3]
chroms[24,1] <- "chrY"
chroms$IMR90 <- chrom_peaks[chrom_peaks$Cell_line == "IMR90", 3]
chroms$SGBS <- chrom_peaks[chrom_peaks$Cell_line == "SGBS", 3]
print(chroms)
```
Видно, что A549 и HUVEC очень похожи по количеству пиков.

Построим для всех этих пиков гистограммку распределения пиков по хромосомам

И еще заменим подписи снизу гистограммы на номер хромосомы сверху, и уберем расцветку

И добавим туда линию, которая нам покажет, как уменьшаются хромосомы по мере возрастания их номера.
!!!(Не сделано пока что)!!!

```{r, echo=FALSE, warning=FALSE}
ggplot(all_peaks, aes(Chromosome, fill = Chromosome))+
  geom_histogram(aes(fill=Chromosome), alpha = 0.5, stat = "count") +
  labs(title = "Peak location distribution",
       x = "Genome location",
       y = "Peak number")+
  theme_bw()+
  facet_wrap(~ Cell_line)
```

Ну что, выглядит вполне красиво и логично - у нас есть пики, которые во всех линиях распределены примерно одинаково, значит, с данными все относительно хорошо.

Чтобы избавиться от шума,бинаризуем пики окошком в 50 п.о., напишем для этого небольшую функцию.

```{r binarization_function}
bin.peaks <- function(dataframe, window_size = 50, append = TRUE)
{
  #Эта функция выдает номера бинов в диапазоне [START, STOP]
  fun <- function(Start, Stop)
  { 
    bin_start <- floor(Start/window_size)*window_size
    bin_stop <- ceiling(Stop/window_size)*window_size - window_size
    positions <- seq(bin_start, bin_stop, by = window_size)
  return(positions)
  }
  
  if (append == TRUE){
    dataframe$Peak_Bins <- mapply(fun, dataframe$Start, dataframe$Stop)
    return(dataframe)
  }else{
    bin_vector <- unlist(mapply(fun, dataframe$Start, dataframe$Stop))
    bin_vector <- sort(bin_vector)
    return(bin_vector)
  }
}
```

Теперь бинаризуем, и добавим для этого столбец Peak_Bins
```{r binarization}
all_peaks <- bin.peaks(all_peaks, window_size = 50)

#Выделим для каждого бина отдельную строку, чтобы было удобнее. Для этого возьмем функцию unnest из пакетика tidyr
all_bins <- unnest(all_peaks, Peak_Bins)
```

Наступает время корреляций! 
Для начала посмотрим на корреляции всех пиков между различными клеточными линиями, убрав, разумеется, Y-хромосому, иначе сравнивать некорректно.


```{r}
#M <- cor(all_bins$)
aggregate <- aggregate(all_bins, by=list(all_bins$Cell_line, all_bins$Chromosome), FUN=cor)


corrplot(M, method = "color", type = "lower")
```



Между всеми пиками и самыми сильными пиками (fold_change>15)

И теперь глянем, какие пики встречаются везде, притянем к ним аннотацию и увидим названия генов. - Дальше выбираем самые мощные из них, подбираем праймеры и все!!






