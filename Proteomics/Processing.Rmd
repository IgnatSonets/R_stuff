---
title: "Proteome_analysis"
output: html_document
---

```{r setup, include=FALSE}
setwd("~/R_stuff/Proteomics/")
library(data.table)
library(ggplot2)
library(biomaRt)
library(dplyr)
library(tidyr)
```
##Подготовка данных
```{r}
raw_data <- fread("raw_data.csv")
raw_data$Total_score <- as.numeric(sapply(raw_data$Total_score, function(x) sub(",", ".", x)))
raw_data$Unused_score <- as.numeric(sapply(raw_data$Unused_score, function(x) sub(",", ".", x)))
raw_data$`% Cov` <- as.numeric(sapply(raw_data$`% Cov`, function(x) sub(",", ".", x)))
raw_data$`% Cov (95)` <- as.numeric(sapply(raw_data$`% Cov (95)`, function(x) sub(",", ".", x)))
raw_data$Accession <- sapply(raw_data$Accession, function(x) unlist(strsplit(x, "|", fixed = T))[2])
setnames(raw_data, "Accession", "Uniprot")
#Удаляем белки с unused score < 1.3
raw_data <- raw_data[raw_data$Unused_score >= 1.3]
```
##Аннотация по Gene Ontology
```{r}
# define biomart object
mart <- useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")

# query biomart
BM_out <- getBM(attributes = c("name_1006", "namespace_1003", "hgnc_symbol", "uniprotswissprot"),
                 filters = "uniprotswissprot",
                values = raw_data$Uniprot, 
                mart = mart,
                uniqueRows = TRUE)

#Удаляем неинформативные GO 
BM_out <- BM_out[BM_out$name_1006 != "molecular_function" &
                  BM_out$name_1006 != "cellular_component" &
                   BM_out$name_1006 != "biological_process" ,]

BM_out <- as.data.table(BM_out)

mol_function <- BM_out[namespace_1003 == "molecular_function", .(uniprotswissprot, hgnc_symbol, name_1006)]
mol_function[, mol_function := .(list(name_1006)), by=uniprotswissprot]
mol_function[, name_1006 := NULL]
mol_function <- mol_function[!duplicated(mol_function)]

cell_component <- BM_out[namespace_1003 == "cellular_component", .(uniprotswissprot, hgnc_symbol, name_1006)]
cell_component[, cell_component := .(list(name_1006)), by=uniprotswissprot]
cell_component[, name_1006 := NULL]
cell_component <- cell_component[!duplicated(cell_component)]

bio_process <- BM_out[namespace_1003 == "biological_process", .(uniprotswissprot, hgnc_symbol, name_1006)]
bio_process[, bio_process := .(list(name_1006)), by=uniprotswissprot]
bio_process[, name_1006 := NULL]
bio_process <- bio_process[!duplicated(bio_process)]

GO_data <- merge(mol_function, cell_component)
GO_data <- merge(GO_data, bio_process)

setnames(GO_data, "uniprotswissprot", "Uniprot")

final_data <- merge(raw_data, GO_data, by = "Uniprot")

rm(BM_out, mol_function, cell_component, bio_process, GO_data, raw_data)
```

Посмотрим, какие группы белков и сколько их там у нас реально есть
```{r}
prot_num <- final_data[, .N , by =. (Cell_line, Treatment, Compartment, Proteome_type)]
print(prot_num[order(N, decreasing = T)])
```
Прикольно, видим, что из ядра настрелялось больше всего белков! 
Хотят тут может быть явный batch-эффект, когда от методики приготовления состав более зависим, чем от обработки. Надо подумать об этом  
  
## RPMI vs IM9
Сравним RPMI и IM9 в контроле по списку белков.
```{r}
final_data[Treatment == "K", .N , by =. (Cell_line, Proteome_type)]
```
  
Что видим, что где-то хорошо прошел эксперимент, а где-то явно так себе. Но мы не будем отчаиваться, будем делать как есть!

```{r}
#Разбили по разным датасетам по клеточной линии
PSMA3 <- final_data[Proteome_type == "PSMA3", ]
PSMA3 <- PSMA3[Treatment == "K", ]

UBD <- final_data[Proteome_type == "UBD_HDAC6", ]
UBD <- UBD[Treatment == "K", ]
```

###PSMA3 пробы

####Найдем общие белки для RPMI и IM9
```{r}
common_PSMA3 <- intersect(PSMA3[Cell_line == "Im9", Uniprot], PSMA3[Cell_line == "RPMI8226", Uniprot]) #Пересекли
common_PSMA3 <- as.data.table(common_PSMA3)
#Переведем идентификаторы Uniprot в NCBI gene symbols

common_PSMA3 <- getBM(attributes = c("hgnc_symbol","uniprotswissprot"),
                 filters = "uniprotswissprot",
                values = common_PSMA3, 
                mart = mart,
                uniqueRows = TRUE)
#common_PSMA3$hgnc_id <- sub("HGNC:", "", common_PSMA3$hgnc_id, fixed = T,) 
common_PSMA3$hgnc_symbol
```
Итого получили для RPMI и IM9 линий `length(common_PSMA3)`общих белков

Что нам говорит msigdb для этих белков:
В топе функций у нас - 
GO_RNA_BINDING
GO_POLY_A_RNA_BINDING
GO_CHROMATIN_SILENCING_AT_RDNA
GO_NEGATIVE_REGULATION_OF_MEGAKARYOCYTE_DIFFERENTIATION
REACTOME_RNA_POL_I_PROMOTER_OPENING
GO_GENE_SILENCING_BY_RNA
GO_NEGATIVE_REGULATION_OF_HEMATOPOIETIC_PROGENITOR_CELL_DIFFERENTIATION
REACTOME_MEIOSIS
GO_REGULATION_OF_MEGAKARYOCYTE_DIFFERENTIATION
GO_TELOMERE_CAPPING

См. файл приложенный msig_all_PSMA3_common.xlsx - там есть и FDR p-value, эти функции белков достоверны. Из 67

По hallmark genesets - похоже, что обогащение на фракцию генов - таргетов MYC
См. файл приложенный msig_hallmark_PSMA3_common.xlsx

####Найдем уникальные белки для RPMI и IM9
Для RPMI линии:
```{r}
unique_RPMI_PSMA3 <- is.element(PSMA3[Cell_line == "RPMI8226", hgnc_symbol], common_PSMA3$hgnc_symbol)
unique_RPMI_PSMA3 <- PSMA3[Cell_line == "RPMI8226", hgnc_symbol][-unique_RPMI_PSMA3]
unique_RPMI_PSMA3
```
Для линии RPMI нашлось `length(unique_RPMI_PSMA3)` уникальных белков

Что это за ребята? 
Смотри файл - msig_all_PSMA3_RPMI_unique.xlsx
Но там та же фигня, 

Для IM9 линии:
```{r}
unique_IM9_PSMA3 <- is.element(PSMA3[Cell_line == "Im9", hgnc_symbol], common_PSMA3$hgnc_symbol)
unique_IM9_PSMA3 <- PSMA3[Cell_line == "Im9", hgnc_symbol][-unique_IM9_PSMA3]
unique_IM9_PSMA3
```
Для линии IM9 нашлось `length(unique_IM9_PSMA3)` уникальных белков
Их тут гораздо больше! 
Что это за ребята? 
Смотри файл - msig_all_PSMA3_IM9_unique.xlsx
Там в основном за РНК-связывание топят

Топ -функций
GO_POLY_A_RNA_BINDING
GO_RNA_BINDING
GO_MACROMOLECULAR_COMPLEX_BINDING
GO_NUCLEAR_OUTER_MEMBRANE_ENDOPLASMIC_RETICULUM_MEMBRANE_NETWORK
GO_CELLULAR_RESPONSE_TO_ORGANIC_SUBSTANCE
GO_RIBONUCLEOPROTEIN_COMPLEX
GO_ENDOPLASMIC_RETICULUM
GO_ENDOPLASMIC_RETICULUM_PART
GO_MEMBRANE_PROTEIN_COMPLEX
GO_IMMUNE_SYSTEM_PROCESS



