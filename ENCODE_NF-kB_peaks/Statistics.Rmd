---
title: "Stats"
author: "Панюшев Николай"
date: '14 ноября 2017 г '
output: html_document
---

#Все графики и статистический анализ здесь

```{r libraries import, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
setwd("~/R_stuff/ENCODE_NF-kB_peaks/")
source("~/R_stuff/Functions.R")
library(ggplot2)
library(tidyr)
library(dplyr)
library(data.table)
library(compiler)
```

```{r, warning=FALSE, message=FALSE, results='hide'} 
setwd("Script_files/")
unzip(zipfile = "all_bins.zip")
all_bins <- fread("all_bins.tsv")
file.remove("all_bins.tsv")
```

##Оценка вероятности получить общие бины случайно

Концепция такая - надо нагенерить случайные данные, чтобы они выглядели примерно как то, что мы видим в реальных данных. 
Для этого сгенерируем 14 (по количеству использованных клеточных линий) векторов с бинами.  

Поэтому порежем геном на кусочки, в каждом из которых есть примерно столько бинов, сколько и в реальных данных. 

Мы работаем с геномом человека он - 3млрд оснований, порежем его на кусочки примерно по 10 кб - и в каждом из этих кусочков сгенерим столько бинов, сколько в том диапазоне, который есть в реальных данных. 


В качестве иллюстрации посмотрим на распределение по 1й хромосоме бинов во всех клеточных линиях
```{r}
ggplot(all_bins[Chromosome=="chr1", ,], aes(Peak_Bins))+
         geom_histogram()+
  facet_wrap(~ Cell_line)+       
  theme_bw()
```

По графику видно, что количество пиков очень сильно варьирует, но профиль повторяется, пиков нет в центромерном участке, например. 

Для начала заведем вектор, в котором сохраним среднее количество бинов в реальных данных.
`r min(all_bins$Peak_Bins)` - координата начала самого первого пика на первой хромосоме
`r max(all_bins$Peak_Bins)` - координата конца самого последнего пика на Y-хромосоме

Вне этих пределов не имеет смысла генерировать бины, потому что их нет в реальных данных совсем.

```{r}
piece_size = 10000
bins_regions <- seq(min(all_bins$Peak_Bins), max(all_bins$Peak_Bins), by = piece_size) #Определили координаты начала участков, где будем пики генерить
```

Cделаем data.table из двух столбцов - где будет начало региона, и среднее по всем линиям количество бинов, которые в этом регионе встречаются

```{r}
bin_number_dt <- matrix(bins_regions, ncol = length(unique(all_bins$Cell_line)),
                        nrow = length(bins_regions))
bin_number_dt <- as.data.table(bin_number_dt)
bin_number_dt <- apply(bin_number_dt, c(1,2), as.list)
#Теперь надо в каждую ячейку вторым элементом листа дописать клеточную линию с помощью := 
bin_number_dt <- bin_number_dt[1L, V1 := 1L]
#Потом пишем функцию и применяем ее ко всем ячейкам


bin_number_dt$max_number <- NA
bin_number_dt$min_number <- NA
bin_number_dt$mean_number <- NA
#bin_number_dt$max_number <- sapply(bin_number_dt$Regions, function(x) max(all_bins[Start > x & Stop < x + piece_size, length(Peak_Bins), by=Cell_line]$V1) )
#bin_number_dt$min_number <- sapply(bin_number_dt$Regions, function(x) min(all_bins[Start > x & Stop < x + piece_size, length(Peak_Bins), by=Cell_line]$V1) )
#bin_number_dt$mean_number <- sapply(bin_number_dt$Regions, function(x) mean(all_bins[Start > x & Stop <= x + piece_size, length(Peak_Bins), by=Cell_line]$V1) )
#bin_number_dt$mean_number <- round(bin_number_dt$mean_number, digits = 0)


rm(bins_regions)
```


##Обобщенная статистика по общим регионам

Сделаем бокс-плот, который покажет, как распределены общие пики по fold_change и по q-value в этих клеточных линиях

Fold change distribution
```{r, echo=F}
#fold_change для начала
ggplot(common_peaks, aes(Cell_line, Fold_change))+
  geom_boxplot()+
  labs(title = "Fold_change distribution of common peaks",
       x = "Cell line",
       y = "Fold change")+
  theme_bw()
```

q-value distribution
```{r, echo=F}
#Теперь q-value
ggplot(common_peaks, aes(Cell_line, common_peaks$`q-value`))+
  geom_boxplot()+
  labs(title = "Fold_change distribution of common peaks",
       x = "Cell line",
       y = "q-value")+
  theme_bw()
```
Картинки примерно повторяют друг друга, видим, что самые качественные пики находятся в AC16, GM18505, HUVEC, IMR90

Глянем, как они распределены общие бины по хромосомам

```{r genome location, echo=F}
#Упорядочим нормально хромосомки, чтобы было красиво
common_bins$Chromosome <- factor(common_bins$Chromosome, 
                                   levels =c("chr1","chr2","chr3","chr4","chr5",
                                             "chr6","chr7","chr8","chr9","chr10",
                                             "chr11", "chr12", "chr13", "chr14", "chr15",
                                             "chr16", "chr17", "chr18", "chr19", "chr20",
                                             "chr21", "chr22", "chrX", "chrY"))

ggplot(common_bins, aes(Chromosome, fill = Chromosome))+
  geom_histogram(aes(fill=Chromosome), alpha = 0.5, stat = "count") +
  labs(title = "Common bin location distribution",
       x = "Genome location",
       y = "Peak number")+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.background = element_rect(fill = "white", 
            colour = NA), panel.border = element_rect(fill = NA, 
            colour = "grey20"), panel.grid.major = element_line(colour = "grey92"), 
            panel.grid.minor = element_line(colour = "grey92", 
                size = 0.25), strip.background = element_rect(fill = "grey85", 
                colour = "grey20"), legend.key = element_rect(fill = "white", 
                colour = NA), complete = TRUE)
```

Выглядит прикольно, видим, что у нас больше всего общих бинов на 1 и на 18 хромосоме.

Интересно, что же там такое?

## График по сочетаниям

Теперь построим график по количеству бинов во всех возможных пересечениях
```{r}
if (!file.exists("combinations.tsv")){
  bins_intersect(all_bins)
}
comb_df <- fread("combinations.tsv", "\t")
```

```{r, echo=F}
#Построим графичек
ggplot(comb_df, aes(x = Line_number, y = Bin_numbers))+
  geom_jitter(alpha = 0.5, color = "red", size = 1.5, na.rm = T)+
  #geom_smooth(method = "nls", formula = Bin_numbers ~ a+Line_number/b*Line_number,  se = FALSE, fullrange = TRUE)+
  labs(title = "Common bin number",
       x = "Number of lines",
       y = "Common peak number")+
  ylim(0, 2e+05)+
theme_bw()
```

```{r}
comb_df[, round(mean(Bin_numbers), digits = 0), by = Line_number] 
```
Всего вышло `r min(comb_df$Bin_numbers)` общих бинов

```{r clean-up, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
rm(list = setdiff(ls(), lsf.str()))
```
