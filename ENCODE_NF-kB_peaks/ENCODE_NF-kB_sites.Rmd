title: "ENCODE_NF-kB"
author: "Панюшев Николай"
date: '15 мая 2017 г '
output: html_document
---

```{r libraries import, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
setwd("~/R_stuff/ENCODE_NF-kB_peaks/")
source("~/R_stuff/Functions.R")
library(ggplot2)
library(tidyr)
library(dplyr)
library(data.table)
library(compiler)
```

Импортнем all_bins
```{r, warning=FALSE, message=FALSE, results='hide'} 
setwd("Script_files/")
unzip(zipfile = "all_bins.zip")
all_bins <- fread("all_bins.tsv")
file.remove("all_bins.tsv")
```

## Пересечения бинов

Посмотрим, есть ли пересечения бинов

```{r}
all_intersect <- Reduce(intersect, all_bins[, .(list(unique(Peak_Bins))), Cell_line]$V1)
```
Итого,количество общих бинов `r length(all_intersect)` 

Теперь отберем только общие бины, остальные нас уже не интересуют
```{r}
common_bins <- all_bins[all_bins$Peak_Bins %in% all_intersect, ]
rm(all_intersect)
```

Глянем, как они распределены общие бины по хромосомам

```{r genome location, echo=F}
ggplot(common_bins, aes(Chromosome, fill = Chromosome))+
  geom_histogram(aes(fill=Chromosome), alpha = 0.5, stat = "count") +
  labs(title = "Common bin location distribution",
       x = "Genome location",
       y = "Peak number")+
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.background = element_rect(fill = "white", 
            colour = NA), panel.border = element_rect(fill = NA, 
            colour = "grey20"), panel.grid.major = element_line(colour = "grey92"), 
            panel.grid.minor = element_line(colour = "grey92", 
                size = 0.25), strip.background = element_rect(fill = "grey85", 
                colour = "grey20"), legend.key = element_rect(fill = "white", 
                colour = NA), complete = TRUE)
```

Выглядит прикольно, видим, что у нас больше всего общих бинов на 1 и на 18 хромосоме.

Интересно, что же там такое?

Подготовим из переменной с бинами полноценный .bed файл
```{r}
#Теперь переведем бины обратно в пики
common_peaks <- aggregate(common_bins$Peak_Bins,
                          by = list(common_bins$Peak_name, common_bins$Cell_line),
                          FUN = min)

names(common_peaks) <- c("Peak_name", "Cell_line", "Start")

common_peaks$Stop <- aggregate(common_bins$Peak_Bins,
                          by = list(common_bins$Peak_name,common_bins$Cell_line),
                          FUN = function(x) max(x)+50)[,3]

common_peaks$Chromosome <- aggregate(common_bins$Chromosome,
                          by = list(common_bins$Peak_name),
                          FUN = function(x) x[1])[,2]

common_peaks$Fold_change <- aggregate(common_bins$fold_change,
                          by = list(common_bins$Peak_name),
                          FUN = function(x) x[1])[,2]

common_peaks$'p-value' <- aggregate(common_bins$`p-value`,
                          by = list(common_bins$Peak_name),
                          FUN = function(x) x[1])[,2]

common_peaks$'q-value' <- aggregate(common_bins$`q-value`,
                          by = list(common_bins$Peak_name),
                          FUN = function(x) x[1])[,2]

common_bins$Summit <- common_bins$Peak_Bins+common_bins$summit_position

common_peaks$Summit <- aggregate(common_bins$Summit,
                          by = list(common_bins$Peak_name),
                          FUN = function(x) x[1])[,2]

#Переставим в правильном порядке столбцы, чтобы bedtools съел
common_peaks <- common_peaks[,c("Chromosome", "Start", "Stop", "Peak_name", "Summit",
                             "Fold_change", "p-value", "q-value", "Cell_line")]

# Проверим, нет ли косяков в .bed файле и запишем в файл
stopifnot(sum(common_peaks$Start > common_peaks$Stop) == 0)
setwd("BEDs/")
fwrite(common_peaks, "common_peaks.bed", sep = "\t", col.names = FALSE)
zip("common_peaks.zip", "common_peaks.bed")
```

Сделаем бокс-плот, который покажет, как распределены общие пики по fold_change и по q-value в этих клеточных линиях

Fold change distribution
```{r, echo=F}
#fold_change для начала
ggplot(common_peaks, aes(Cell_line, Fold_change))+
  geom_boxplot()+
  labs(title = "Fold_change distribution of common peaks",
       x = "Cell line",
       y = "Fold change")+
  theme_bw()
```

q-value distribution
```{r, echo=F}
#Теперь q-value
ggplot(common_peaks, aes(Cell_line, common_peaks$`q-value`))+
  geom_boxplot()+
  labs(title = "Fold_change distribution of common peaks",
       x = "Cell line",
       y = "q-value")+
  theme_bw()
```
Картинки примерно повторяют друг друга, видим, что самые качественные пики находятся в AC16, GM18505, HUVEC, IMR90

Выгрузим последовательности в fasta.

Запустим для этого bedtools
```{r common_bins.fa, engine="bash"}
#Reference genome was downloaded from here ftp://ftp.sanger.ac.uk/pub/gencode/Gencode_human/release_24/GRCh38.p5.genome.fa.gz
cd ~/R_stuff/ENCODE_NF-kB_peaks/FASTAs/
bedtools getfasta -fo common_bins.fa -fi ~/Human_genome/Genprime_v24/genprime_v24.fa -bed ~/R_stuff/ENCODE_NF-kB_peaks/BEDs/common_bins.bed
zip common_bins.zip common_bins.fa && rm common_bins.fa 
```

###Отцентруем по саммитам
Так как у нас есть саммиты для каждого из пиков, то сделаем .bed, где все участки общие будут отцентрованы по позиции саммита.
Заодно удлинним до 1000 нуклеотидов общие участки, во избежание всяких погрешностей 
```{r summit_centered}
region_length <- 1000
for_fasta <- common_peaks
for_fasta$Start <- common_peaks$Summit - region_length/2
for_fasta$Stop <- common_peaks$Summit + region_length/2

for_fasta$Stop - for_fasta$Start  == region_length #Проверили, все ли у нас получилось

# Сделаем .bed
fwrite(for_fasta, file = "BEDs/1000_centered.bed", sep = "\t", col.names = FALSE)
zip("BEDs/1000_centered.zip", "1000_centered.bed")
rm(region_length, for_fasta)
```

```{r 1000_centered.fa, engine='bash'}
cd ~/R_stuff/ENCODE_NF-kB_peaks/FASTAs
bedtools getfasta -fo ~/FASTAs/1000_centered.fa -fi ~/Human_genome/Genprime_v24/genprime_v24.fa -bed ~/R_stuff/ENCODE_NF-kB_peaks/1000_centered.bed
zip 1000_centered.zip 1000_centered.fa && rm 1000_centered.fa
```

Попробуем вытащить бэкграунд для консенсусных сайтов - для этого нам надо отфильтровать мусор всякий.
То есть возьмем бины, которые встречаются в 2х клеточных линиях, если будем брать больше, то бэкграундных бинов будет слишком мало
 
```{r}
for (i in 1:5){
  t <- sample(unique(all_bins$Cell_line), size = 2)
  intersect <- intersect(all_bins[Cell_line == t[1], Peak_Bins],
                        all_bins[Cell_line == t[2], Peak_Bins])
  temp_bins <- all_bins[all_bins$Peak_Bins %in% intersect, 
                        .(Chromosome, Cell_line, Peak_name, Peak_Bins) ]
  temp_bins <- temp_bins[Cell_line == t[1], .(Chromosome, Peak_Bins), by=Peak_name]
  temp_bins <- temp_bins[ , .(Chromosome, Start = min(Peak_Bins), 
                                  Stop = max(Peak_Bins)+50), by=Peak_name]
  temp_bins <- temp_bins[!duplicated(temp_bins), ]
  temp_bins$new_start <- temp_bins$Start - (500 - (temp_bins$Stop - temp_bins$Start))/2
  temp_bins$new_stop <- temp_bins$Stop + (500 - (temp_bins$Stop - temp_bins$Start))/2
  temp_bins$Peak_name <- temp_bins$Start <- temp_bins$Stop <- NULL
  filename <- paste(c(t, "bg.bed"), collapse = "_")
  fwrite(temp_bins, filename, sep = "\t", col.names = FALSE)
  rm(filename, i, t, temp_bins, intersect)
}
```

Теперь сделаем из .bed .fasta
Этот кусок кода не работает из R, только в консоли почему-то.
```{r bed to fasta, engine='bash', eval = F}
for i in *bg.bed
do
    TAG=${i%%.bed}
    bedtools getfasta -fo $TAG.fa -fi ~/Human_genome/Genprime_v24/genprime_v24.fa -bed ~/R_stuff/ENCODE_NF-kB_peaks/$i
    rm $i
done
```



```{r clean-up, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
file.remove("common_peaks.bed")
file.remove("1000_centered.bed")
rm(list = setdiff(ls(), lsf.str()))
gc()
```
